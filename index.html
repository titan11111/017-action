<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>ğŸŒ† ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ãƒ»ãƒã‚ªã‚·ãƒ†ã‚£ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --neon-cyan: #00ffff;
      --neon-pink: #ff00ff;
      --neon-yellow: #ffff00;
      --dark-bg: #0a0a0f;
      --cyber-dark: #1a1a2e;
      --cyber-blue: #0f3460;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
      overflow: hidden;
      font-family: 'Orbitron', monospace;
      color: #eee;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* ã‚µã‚¤ãƒãƒ¼èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .cyber-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }

    .cyber-grid {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        linear-gradient(to right, rgba(0, 255, 255, 0.1) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      opacity: 0.3;
      animation: gridFlow 30s linear infinite;
    }

    @keyframes gridFlow {
      from { transform: translate(0, 0); }
      to { transform: translate(50px, 50px); }
    }

    /* ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ */
    #gameContainer {
      position: relative;
      width: 800px;
      height: 600px;
      overflow: hidden;
      border: 3px solid var(--neon-cyan);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
      background-color: var(--cyber-dark);
    }

    #gameCanvas {
      display: block;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, #0a0a1a, #000);
    }

    /* HUD */
    #gameInfo {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.7);
      border-bottom: 2px solid var(--neon-cyan);
      z-index: 5;
      font-size: 14px;
      color: var(--neon-cyan);
      font-weight: bold;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0, 255, 255, 0.1);
      padding: 5px 15px;
      border-radius: 20px;
      border: 1px solid var(--neon-cyan);
    }

    .info-value {
      color: var(--neon-yellow);
      font-size: 18px;
      text-shadow: 0 0 10px var(--neon-yellow);
    }

    /* ãƒ¢ãƒã‚¤ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    #mobileControls {
      display: none;
    }

    .control-btn {
      background: linear-gradient(135deg, var(--cyber-blue), var(--cyber-dark));
      border: 2px solid var(--neon-cyan);
      border-radius: 15px;
      color: var(--neon-cyan);
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      touch-action: manipulation;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.1s;
    }

    .control-btn:active {
      transform: scale(0.95);
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.8);
    }

    .jump-btn {
      background: linear-gradient(135deg, var(--neon-pink), var(--cyber-dark));
      border-color: var(--neon-pink);
      color: var(--neon-pink);
      box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
    #messageScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 20;
      padding: 20px;
    }

    .message-content {
      background: var(--cyber-dark);
      border: 3px solid var(--neon-pink);
      box-shadow: 0 0 30px rgba(255, 0, 255, 0.7);
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      text-align: center;
    }

    #messageTitle {
      font-size: 24px;
      margin-bottom: 20px;
      color: var(--neon-cyan);
      text-shadow: 0 0 10px var(--neon-cyan);
    }

    #messageText {
      margin-bottom: 30px;
      color: #eee;
      line-height: 1.6;
      font-size: 14px;
    }

    .start-btn {
      background: var(--cyber-blue);
      color: #fff;
      border: 2px solid var(--neon-cyan);
      border-radius: 8px;
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
    }

    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 255, 255, 0.6);
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      #gameContainer {
        width: 100vw;
        height: 100vh;
        border: none;
        border-radius: 0;
      }

      #gameInfo {
        font-size: 12px;
        padding: 5px 10px;
      }

      .info-item {
        padding: 3px 8px;
      }

      .info-value {
        font-size: 14px;
      }

      #mobileControls {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10;
        pointer-events: none;
      }

      #leftBtn, #rightBtn {
        position: absolute;
        bottom: 20px;
        width: 70px;
        height: 70px;
        pointer-events: auto;
      }

      #leftBtn {
        left: 20px;
      }

      #rightBtn {
        left: 100px;
      }

      #jumpBtn {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 90px;
        height: 90px;
        pointer-events: auto;
      }
    }
  </style>
</head>
<body>
  <div class="cyber-bg">
    <div class="cyber-grid"></div>
  </div>

  <div id="gameContainer">
    <div id="gameInfo">
      <div class="info-item">
        <span>STAGE</span>
        <span id="currentStage" class="info-value">1</span>
      </div>
      <div class="info-item">
        <span>LIFE</span>
        <span id="currentLife" class="info-value">3</span>
      </div>
      <div class="info-item">
        <span>SCORE</span>
        <span id="currentScore" class="info-value">0</span>
      </div>
    </div>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="mobileControls">
      <button id="leftBtn" class="control-btn">â—€</button>
      <button id="rightBtn" class="control-btn">â–¶</button>
      <button id="jumpBtn" class="control-btn jump-btn">â¬†</button>
    </div>

    <div id="messageScreen">
      <div class="message-content">
        <h2 id="messageTitle">CYBER CITY ADVENTURE</h2>
        <p id="messageText">ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ã®ä¸–ç•Œã‚’å†’é™ºã—ã‚ˆã†ï¼<br>10ã‚¹ãƒ†ãƒ¼ã‚¸å…¨ã‚¯ãƒªã‚¢ã‚’ç›®æŒ‡ã›ï¼</p>
        <button id="messageButton" class="start-btn">START GAME</button>
      </div>
    </div>
  </div>

  <script>
    // ã‚²ãƒ¼ãƒ è¨­å®š
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const messageScreen = document.getElementById('messageScreen');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const messageButton = document.getElementById('messageButton');
    const currentStageSpan = document.getElementById('currentStage');
    const currentLifeSpan = document.getElementById('currentLife');
    const currentScoreSpan = document.getElementById('currentScore');

    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
    let gameState = 'menu';
    let currentStage = 1;
    let playerLife = 3;
    let score = 0;
    let animationId = null;
    const keys = { left: false, right: false, space: false };

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
    const player = {
      x: 50, y: 200,
      width: 30, height: 40,
      velocityX: 0, velocityY: 0,
      speed: 5, jumpPower: 12,
      onGround: false,
      invulnerable: false,
      invulnerableTime: 0,
      color: '#00ff00'
    };

    // ç‰©ç†è¨­å®š
    const gravity = 0.5;
    const maxFallSpeed = 10;
    let platforms = [];
    let enemies = [];
    let items = [];
    let particles = [];
    let goal = { x: 750, y: 100, width: 30, height: 40 };

    // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—çŠ¶æ…‹
    let powerUps = {
      speedBoost: { active: false, timer: 0 },
      highJump: { active: false, timer: 0 },
      shield: { active: false, timer: 0 }
    };

    // 10ã‚¹ãƒ†ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿
    const stageData = [
      // Stage 1 - ç°¡å˜ãªå…¥é–€ã‚¹ãƒ†ãƒ¼ã‚¸
      {
        name: "CYBER START",
        bgColor: "#001122",
        platforms: [
          { x: 0, y: 550, width: 800, height: 50 },
          { x: 100, y: 450, width: 100, height: 20 },
          { x: 300, y: 350, width: 150, height: 20 },
          { x: 500, y: 400, width: 100, height: 20 },
          { x: 650, y: 300, width: 100, height: 20 }
        ],
        enemies: [
          { x: 350, y: 310, width: 30, height: 30, speed: 1, range: 100 }
        ],
        items: [
          { x: 150, y: 410, type: 'coin' },
          { x: 375, y: 310, type: 'heart' },
          { x: 550, y: 360, type: 'coin' }
        ],
        goalY: 260
      },
      // Stage 2
      {
        name: "NEON CITY",
        bgColor: "#0a0a2a",
        platforms: [
          { x: 0, y: 550, width: 800, height: 50 },
          { x: 80, y: 470, width: 80, height: 20 },
          { x: 200, y: 400, width: 100, height: 20 },
          { x: 350, y: 330, width: 80, height: 20 },
          { x: 480, y: 280, width: 120, height: 20 },
          { x: 650, y: 200, width: 100, height: 20 }
        ],
        enemies: [
          { x: 250, y: 360, width: 30, height: 30, speed: 1.5, range: 80 },
          { x: 500, y: 240, width: 30, height: 30, speed: 1, range: 100 }
        ],
        items: [
          { x: 120, y: 430, type: 'coin' },
          { x: 390, y: 290, type: 'speedBoost' },
          { x: 530, y: 240, type: 'coin' }
        ],
        goalY: 160
      },
      // Stage 3
      {
        name: "DATA STREAM",
        bgColor: "#1a0a1a",
        platforms: [
          { x: 0, y: 550, width: 800, height: 50 },
          { x: 50, y: 480, width: 60, height: 20 },
          { x: 150, y: 430, width: 80, height: 20 },
          { x: 270, y: 380, width: 60, height: 20 },
          { x: 370, y: 320, width: 100, height: 20 },
          { x: 520, y: 270, width: 80, height: 20 },
          { x: 650, y: 220, width: 100, height: 20 }
        ],
        enemies: [
          { x: 200, y: 390, width: 30, height: 30, speed: 2, range: 60 },
          { x: 420, y: 280, width: 30, height: 30, speed: 1.5, range: 80 },
          { x: 560, y: 230, width: 30, height: 30, speed: 1, range: 60 }
        ],
        items: [
          { x: 80, y: 440, type: 'coin' },
          { x: 300, y: 340, type: 'highJump' },
          { x: 420, y: 280, type: 'heart' },
          { x: 690, y: 180, type: 'coin' }
        ],
        goalY: 180
      },
      // Stage 4
      {
        name: "MATRIX ZONE",
        bgColor: "#0a1a1a",
        platforms: [
          { x: 0, y: 550, width: 800, height: 50 },
          { x: 100, y: 500, width: 70, height: 20 },
          { x: 220, y: 450, width: 70, height: 20 },
          { x: 340, y: 400, width: 70, height: 20 },
          { x: 460, y: 350, width: 70, height: 20 },
          { x: 580, y: 300, width: 70, height: 20 },
          { x: 700, y: 250, width: 80, height: 20 }
        ],
        enemies: [
          { x: 250, y: 410, width: 30, height: 30, speed: 2, range: 50 },
          { x: 370, y: 360, width: 30, height: 30, speed: 2.5, range: 50 },
          { x: 490, y: 310, width: 30, height: 30, speed: 2, range: 50 },
          { x: 610, y: 260, width: 30, height: 30, speed: 1.5, range: 50 }
        ],
        items: [
          { x: 135, y: 460, type: 'coin' },
          { x: 255, y: 410, type: 'shield' },
          { x: 495, y: 310, type: 'coin' },
          { x: 615, y: 260, type: 'heart' }
        ],
        goalY: 210
      },
      // Stage 5 - ä¸­é–“åœ°ç‚¹
      {
        name: "CYBER CORE",
        bgColor: "#2a0a2a",
        platforms: [
          { x: 0, y: 550, width: 800, height: 50 },
          { x: 80, y: 490, width: 100, height: 20 },
          { x: 230, y: 430, width: 60, height: 20 },
          { x: 340, y: 370, width: 100, height: 20 },
          { x: 490, y: 310, width: 60, height: 20 },
          { x: 600, y: 250, width: 100, height: 20 },
          { x: 400, y: 480, width: 80, height: 20 }
        ],
        enemies: [
          { x: 130, y: 450, width: 30, height: 30, speed: 2, range: 80 },
          { x: 260, y: 390, width: 30, height: 30, speed: 2.5, range: 40 },
          { x: 390, y: 330, width: 30, height: 30, speed: 3, range: 80 },
          { x: 520, y: 270, width: 30, height: 30, speed: 2, range: 40 },
          { x: 650, y: 210, width: 30, height: 30, speed: 2.5, range: 80 }
        ],
        items: [
          { x: 130, y: 450, type: 'speedBoost' },
          { x: 390, y: 330, type: 'heart' },
          { x: 440, y: 440, type: 'coin' },
          { x: 650, y: 210, type: 'shield' }
        ],
        goalY: 210
      },
      // Stage 6
      {
        name: "DIGITAL VOID",
        bgColor: "#1a1a2a",
        platforms: [
          { x: 0, y: 550, width: 800, height: 50 },
          { x: 60, y: 500, width: 60, height: 20 },
          { x: 170, y: 460, width: 60, height: 20 },
          { x: 280, y: 420, width: 60, height: 20 },
          { x: 390, y: 380, width: 60, height: 20 },
          { x: 500, y: 340, width: 60, height: 20 },
          { x: 610, y: 300, width: 60, height: 20 },
          { x: 720, y: 260, width: 60, height: 20 }
        ],
        enemies: [
          { x: 200, y: 420, width: 30, height: 30, speed: 2.5, range: 50 },
          { x: 310, y: 380, width: 30, height: 30, speed: 3, range: 50 },
          { x: 420, y: 340, width: 30, height: 30, speed: 2.5, range: 50 },
          { x: 530, y: 300, width: 30, height: 30, speed: 3, range: 50 },
          { x: 640, y: 260, width: 30, height: 30, speed: 2.5, range: 50 }
        ],
        items: [
          { x: 90, y: 460, type: 'coin' },
          { x: 310, y: 380, type: 'highJump' },
          { x: 530, y: 300, type: 'heart' },
          { x: 750, y: 220, type: 'coin' }
        ],
        goalY: 220
      },
      // Stage 7
      {
        name: "NEON NEXUS",
        bgColor: "#2a1a0a",
        platforms: [
          { x: 0, y: 550, width: 800, height: 50 },
          { x: 100, y: 480, width: 50, height: 20 },
          { x: 200, y: 420, width: 50, height: 20 },
          { x: 300, y: 360, width: 50, height: 20 },
          { x: 400, y: 300, width: 50, height: 20 },
          { x: 500, y: 240, width: 50, height: 20 },
          { x: 600, y: 180, width: 50, height: 20 },
          { x: 700, y: 120, width: 80, height: 20 }
        ],
        enemies: [
          { x: 125, y: 440, width: 30, height: 30, speed: 3, range: 30 },
          { x: 225, y: 380, width: 30, height: 30, speed: 3.5, range: 30 },
          { x: 325, y: 320, width: 30, height: 30, speed: 3, range: 30 },
          { x: 425, y: 260, width: 30, height: 30, speed: 3.5, range: 30 },
          { x: 525, y: 200, width: 30, height: 30, speed: 3, range: 30 },
          { x: 625, y: 140, width: 30, height: 30, speed: 3.5, range: 30 }
        ],
        items: [
          { x: 225, y: 380, type: 'speedBoost' },
          { x: 425, y: 260, type: 'shield' },
          { x: 625, y: 140, type: 'heart' },
          { x: 740, y: 80, type: 'coin' }
        ],
        goalY: 80
      },
      // Stage 8
      {
        name: "QUANTUM LEAP",
        bgColor: "#0a2a2a",
        platforms: [
          { x: 0, y: 550, width: 800, height: 50 },
          { x: 80, y: 470, width: 40, height: 20 },
          { x: 180, y: 390, width: 40, height: 20 },
          { x: 280, y: 310, width: 40, height: 20 },
          { x: 380, y: 230, width: 40, height: 20 },
          { x: 480, y: 310, width: 40, height: 20 },
          { x: 580, y: 390, width: 40, height: 20 },
          { x: 680, y: 470, width: 40, height: 20 },
          { x: 750, y: 150, width: 50, height: 20 }
        ],
        enemies: [
          { x: 100, y: 430, width: 30, height: 30, speed: 3.5, range: 20 },
          { x: 200, y: 350, width: 30, height: 30, speed: 4, range: 20 },
          { x: 300, y: 270, width: 30, height: 30, speed: 3.5, range: 20 },
          { x: 400, y: 190, width: 30, height: 30, speed: 4, range: 20 },
          { x: 500, y: 270, width: 30, height: 30, speed: 3.5, range: 20 },
          { x: 600, y: 350, width: 30, height: 30, speed: 4, range: 20 },
          { x: 700, y: 430, width: 30, height: 30, speed: 3.5, range: 20 }
        ],
        items: [
          { x: 200, y: 350, type: 'highJump' },
          { x: 400, y: 190, type: 'speedBoost' },
          { x: 600, y: 350, type: 'shield' },
          { x: 775, y: 110, type: 'heart' }
        ],
        goalY: 110
      },
      // Stage 9
      {
        name: "CYBER STORM",
        bgColor: "#3a0a3a",
        platforms: [
          { x: 0, y: 550, width: 800, height: 50 },
          { x: 50, y: 500, width: 40, height: 20 },
          { x: 130, y: 450, width: 40, height: 20 },
          { x: 210, y: 400, width: 40, height: 20 },
          { x: 290, y: 350, width: 40, height: 20 },
          { x: 370, y: 300, width: 40, height: 20 },
          { x: 450, y: 250, width: 40, height: 20 },
          { x: 530, y: 200, width: 40, height: 20 },
          { x: 610, y: 150, width: 40, height: 20 },
          { x: 690, y: 100, width: 40, height: 20 },
          { x: 760, y: 50, width: 40, height: 20 }
        ],
        enemies: [
          { x: 70, y: 460, width: 30, height: 30, speed: 4, range: 20 },
          { x: 150, y: 410, width: 30, height: 30, speed: 4.5, range: 20 },
          { x: 230, y: 360, width: 30, height: 30, speed: 4, range: 20 },
          { x: 310, y: 310, width: 30, height: 30, speed: 4.5, range: 20 },
          { x: 390, y: 260, width: 30, height: 30, speed: 4, range: 20 },
          { x: 470, y: 210, width: 30, height: 30, speed: 4.5, range: 20 },
          { x: 550, y: 160, width: 30, height: 30, speed: 4, range: 20 },
          { x: 630, y: 110, width: 30, height: 30, speed: 4.5, range: 20 }
        ],
        items: [
          { x: 230, y: 360, type: 'speedBoost' },
          { x: 390, y: 260, type: 'highJump' },
          { x: 550, y: 160, type: 'shield' },
          { x: 780, y: 10, type: 'heart' }
        ],
        goalY: 10
      },
      // Stage 10 - æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¸
      {
        name: "FINAL CORE",
        bgColor: "#4a0a4a",
        platforms: [
          { x: 0, y: 550, width: 800, height: 50 },
          { x: 60, y: 490, width: 30, height: 20 },
          { x: 120, y: 430, width: 30, height: 20 },
          { x: 180, y: 370, width: 30, height: 20 },
          { x: 240, y: 310, width: 30, height: 20 },
          { x: 300, y: 250, width: 30, height: 20 },
          { x: 360, y: 190, width: 30, height: 20 },
          { x: 420, y: 250, width: 30, height: 20 },
          { x: 480, y: 310, width: 30, height: 20 },
          { x: 540, y: 370, width: 30, height: 20 },
          { x: 600, y: 430, width: 30, height: 20 },
          { x: 660, y: 490, width: 30, height: 20 },
          { x: 720, y: 130, width: 60, height: 20 }
        ],
        enemies: [
          { x: 90, y: 450, width: 30, height: 30, speed: 5, range: 20 },
          { x: 150, y: 390, width: 30, height: 30, speed: 5, range: 20 },
          { x: 210, y: 330, width: 30, height: 30, speed: 5, range: 20 },
          { x: 270, y: 270, width: 30, height: 30, speed: 5, range: 20 },
          { x: 330, y: 210, width: 30, height: 30, speed: 5, range: 20 },
          { x: 390, y: 150, width: 30, height: 30, speed: 5, range: 20 },
          { x: 450, y: 210, width: 30, height: 30, speed: 5, range: 20 },
          { x: 510, y: 270, width: 30, height: 30, speed: 5, range: 20 },
          { x: 570, y: 330, width: 30, height: 30, speed: 5, range: 20 },
          { x: 630, y: 390, width: 30, height: 30, speed: 5, range: 20 }
        ],
        items: [
          { x: 270, y: 210, type: 'speedBoost' },
          { x: 330, y: 150, type: 'highJump' },
          { x: 510, y: 270, type: 'shield' },
          { x: 750, y: 90, type: 'heart' }
        ],
        goalY: 90
      }
    ];

    // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
    function loadStage(stageIndex) {
      const stage = stageData[stageIndex - 1];
      platforms = [...stage.platforms];
      enemies = stage.enemies.map(e => ({
        ...e,
        startX: e.x,
        direction: 1
      }));
      items = stage.items.map(item => ({
        ...item,
        x: item.x,
        y: item.y,
        width: 20,
        height: 20,
        collected: false
      }));
      goal.y = stage.goalY;
      
      // èƒŒæ™¯è‰²ã‚’è¨­å®š
      canvas.style.background = `linear-gradient(to bottom, ${stage.bgColor}, #000)`;
    }

    // åˆæœŸåŒ–
    function init() {
      setupEventListeners();
      updateUI();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') keys.left = true;
        if (e.key === 'ArrowRight') keys.right = true;
        if (e.key === ' ' || e.key === 'ArrowUp') {
          keys.space = true;
          e.preventDefault();
        }
      });

      document.addEventListener('keyup', (e) => {
        if (e.key === 'ArrowLeft') keys.left = false;
        if (e.key === 'ArrowRight') keys.right = false;
        if (e.key === ' ' || e.key === 'ArrowUp') keys.space = false;
      });

      // ãƒ¢ãƒã‚¤ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
      const leftBtn = document.getElementById('leftBtn');
      const rightBtn = document.getElementById('rightBtn');
      const jumpBtn = document.getElementById('jumpBtn');

      if (leftBtn) {
        leftBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          keys.left = true;
        });
        leftBtn.addEventListener('touchend', () => keys.left = false);
        leftBtn.addEventListener('mousedown', () => keys.left = true);
        leftBtn.addEventListener('mouseup', () => keys.left = false);
      }

      if (rightBtn) {
        rightBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          keys.right = true;
        });
        rightBtn.addEventListener('touchend', () => keys.right = false);
        rightBtn.addEventListener('mousedown', () => keys.right = true);
        rightBtn.addEventListener('mouseup', () => keys.right = false);
      }

      if (jumpBtn) {
        jumpBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          keys.space = true;
        });
        jumpBtn.addEventListener('touchend', () => keys.space = false);
        jumpBtn.addEventListener('mousedown', () => keys.space = true);
        jumpBtn.addEventListener('mouseup', () => keys.space = false);
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœã‚¿ãƒ³
      messageButton.addEventListener('click', handleMessageButton);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœã‚¿ãƒ³å‡¦ç†
    function handleMessageButton() {
      if (gameState === 'menu') {
        startGame();
      } else if (gameState === 'stageClear') {
        nextStage();
      } else if (gameState === 'gameOver' || gameState === 'gameComplete') {
        resetGame();
      }
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame() {
      gameState = 'playing';
      currentStage = 1;
      playerLife = 3;
      score = 0;
      resetPlayer();
      loadStage(currentStage);
      hideMessage();
      updateUI();
      gameLoop();
    }

    // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸
    function nextStage() {
      currentStage++;
      if (currentStage > 10) {
        gameComplete();
      } else {
        gameState = 'playing';
        resetPlayer();
        loadStage(currentStage);
        hideMessage();
        updateUI();
      }
    }

    // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    function resetGame() {
      gameState = 'menu';
      currentStage = 1;
      playerLife = 3;
      score = 0;
      resetPlayer();
      showMessage('CYBER CITY ADVENTURE', 'ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ã®ä¸–ç•Œã‚’å†’é™ºã—ã‚ˆã†ï¼<br>10ã‚¹ãƒ†ãƒ¼ã‚¸å…¨ã‚¯ãƒªã‚¢ã‚’ç›®æŒ‡ã›ï¼', 'START GAME');
      updateUI();
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚»ãƒƒãƒˆ
    function resetPlayer() {
      player.x = 50;
      player.y = 200;
      player.velocityX = 0;
      player.velocityY = 0;
      player.onGround = false;
      player.invulnerable = false;
      player.invulnerableTime = 0;
      
      // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ãƒªã‚»ãƒƒãƒˆ
      powerUps.speedBoost = { active: false, timer: 0 };
      powerUps.highJump = { active: false, timer: 0 };
      powerUps.shield = { active: false, timer: 0 };
    }

    // UIæ›´æ–°
    function updateUI() {
      currentStageSpan.textContent = currentStage;
      currentLifeSpan.textContent = playerLife;
      currentScoreSpan.textContent = score;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(title, text, button) {
      messageTitle.textContent = title;
      messageText.innerHTML = text;
      messageButton.textContent = button;
      messageScreen.style.display = 'flex';
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤º
    function hideMessage() {
      messageScreen.style.display = 'none';
    }

    // è¡çªåˆ¤å®š
    function checkCollision(r1, r2) {
      return r1.x < r2.x + r2.width &&
             r1.x + r1.width > r2.x &&
             r1.y < r2.y + r2.height &&
             r1.y + r1.height > r2.y;
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–°
    function updatePlayer() {
      // ç§»å‹•é€Ÿåº¦ã®é©ç”¨
      let currentSpeed = player.speed;
      if (powerUps.speedBoost.active) {
        currentSpeed *= 1.5;
      }

      if (keys.left) player.velocityX = -currentSpeed;
      else if (keys.right) player.velocityX = currentSpeed;
      else player.velocityX *= 0.8;

      // ã‚¸ãƒ£ãƒ³ãƒ—
      let currentJumpPower = player.jumpPower;
      if (powerUps.highJump.active) {
        currentJumpPower *= 1.3;
      }

      if (keys.space && player.onGround) {
        player.velocityY = -currentJumpPower;
        player.onGround = false;
      }

      // é‡åŠ›
      player.velocityY += gravity;
      if (player.velocityY > maxFallSpeed) {
        player.velocityY = maxFallSpeed;
      }

      // ä½ç½®æ›´æ–°
      player.x += player.velocityX;
      player.y += player.velocityY;

      // ç”»é¢å¢ƒç•Œ
      if (player.x < 0) player.x = 0;
      if (player.x + player.width > canvas.width) {
        player.x = canvas.width - player.width;
      }

      // è½ä¸‹åˆ¤å®š
      if (player.y > canvas.height) {
        loseLife();
      }

      // ç„¡æ•µæ™‚é–“
      if (player.invulnerable) {
        player.invulnerableTime--;
        if (player.invulnerableTime <= 0) {
          player.invulnerable = false;
        }
      }

      // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
      Object.keys(powerUps).forEach(key => {
        if (powerUps[key].active) {
          powerUps[key].timer--;
          if (powerUps[key].timer <= 0) {
            powerUps[key].active = false;
          }
        }
      });

      // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¡çª
      player.onGround = false;
      platforms.forEach(platform => {
        if (checkCollision(player, platform)) {
          if (player.velocityY > 0 && player.y < platform.y) {
            player.y = platform.y - player.height;
            player.velocityY = 0;
            player.onGround = true;
          }
        }
      });
    }

    // æ•µæ›´æ–°
    function updateEnemies() {
      enemies.forEach(enemy => {
        enemy.x += enemy.speed * enemy.direction;
        
        if (Math.abs(enemy.x - enemy.startX) > enemy.range) {
          enemy.direction *= -1;
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®è¡çª
        if (!player.invulnerable && !powerUps.shield.active && checkCollision(player, enemy)) {
          loseLife();
        }
      });
    }

    // ã‚¢ã‚¤ãƒ†ãƒ æ›´æ–°
    function updateItems() {
      items = items.filter(item => {
        if (!item.collected && checkCollision(player, item)) {
          collectItem(item);
          return false;
        }
        return !item.collected;
      });
    }

    // ã‚¢ã‚¤ãƒ†ãƒ åé›†
    function collectItem(item) {
      switch(item.type) {
        case 'coin':
          score += 100;
          createParticles(item.x + 10, item.y + 10, '#ffd700');
          break;
        case 'heart':
          if (playerLife < 5) {
            playerLife++;
          }
          score += 50;
          createParticles(item.x + 10, item.y + 10, '#ff69b4');
          break;
        case 'speedBoost':
          powerUps.speedBoost = { active: true, timer: 300 };
          createParticles(item.x + 10, item.y + 10, '#00ffff');
          break;
        case 'highJump':
          powerUps.highJump = { active: true, timer: 300 };
          createParticles(item.x + 10, item.y + 10, '#ff00ff');
          break;
        case 'shield':
          powerUps.shield = { active: true, timer: 300 };
          createParticles(item.x + 10, item.y + 10, '#ffff00');
          break;
      }
      updateUI();
    }

    // ãƒ©ã‚¤ãƒ•æ¶ˆå¤±
    function loseLife() {
      if (player.invulnerable || powerUps.shield.active) return;

      playerLife--;
      updateUI();
      
      if (playerLife <= 0) {
        gameOver();
      } else {
        player.invulnerable = true;
        player.invulnerableTime = 120;
        resetPlayer();
        createParticles(player.x + player.width/2, player.y + player.height/2, '#ff0000');
      }
    }

    // ã‚´ãƒ¼ãƒ«åˆ¤å®š
    function checkGoal() {
      if (checkCollision(player, goal)) {
        stageClear();
      }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
    function stageClear() {
      gameState = 'stageClear';
      score += 500;
      updateUI();
      showMessage(
        `STAGE ${currentStage} CLEAR!`,
        `ã‚¹ã‚³ã‚¢: ${score}<br>æ®‹ã‚Šãƒ©ã‚¤ãƒ•: ${playerLife}`,
        'NEXT STAGE'
      );
    }

    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
    function gameOver() {
      gameState = 'gameOver';
      showMessage(
        'GAME OVER',
        `æœ€çµ‚ã‚¹ã‚³ã‚¢: ${score}<br>åˆ°é”ã‚¹ãƒ†ãƒ¼ã‚¸: ${currentStage}`,
        'RETRY'
      );
    }

    // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢
    function gameComplete() {
      gameState = 'gameComplete';
      score += 1000;
      updateUI();
      showMessage(
        'CONGRATULATIONS!',
        `å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼<br>æœ€çµ‚ã‚¹ã‚³ã‚¢: ${score}`,
        'PLAY AGAIN'
      );
    }

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ä½œæˆ
    function createParticles(x, y, color) {
      for (let i = 0; i < 8; i++) {
        particles.push({
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 5,
          vy: (Math.random() - 0.5) * 5,
          life: 30,
          color: color
        });
      }
    }

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ›´æ–°
    function updateParticles() {
      particles = particles.filter(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.2;
        p.life--;
        return p.life > 0;
      });
    }

    // æç”»
    function draw() {
      // èƒŒæ™¯ã‚¯ãƒªã‚¢
      ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æç”»
      ctx.fillStyle = '#00ff88';
      platforms.forEach(platform => {
        ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        
        // ãƒã‚ªãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        ctx.strokeStyle = '#00ffaa';
        ctx.lineWidth = 2;
        ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
      });

      // ã‚¢ã‚¤ãƒ†ãƒ æç”»
      items.forEach(item => {
        if (!item.collected) {
          switch(item.type) {
            case 'coin':
              ctx.fillStyle = '#ffd700';
              ctx.beginPath();
              ctx.arc(item.x + 10, item.y + 10, 8, 0, Math.PI * 2);
              ctx.fill();
              break;
            case 'heart':
              ctx.fillStyle = '#ff69b4';
              ctx.fillRect(item.x, item.y, 20, 20);
              break;
            case 'speedBoost':
              ctx.fillStyle = '#00ffff';
              ctx.fillRect(item.x + 5, item.y, 10, 20);
              ctx.fillRect(item.x, item.y + 7, 20, 6);
              break;
            case 'highJump':
              ctx.fillStyle = '#ff00ff';
              ctx.beginPath();
              ctx.moveTo(item.x + 10, item.y);
              ctx.lineTo(item.x + 20, item.y + 20);
              ctx.lineTo(item.x, item.y + 20);
              ctx.closePath();
              ctx.fill();
              break;
            case 'shield':
              ctx.fillStyle = '#ffff00';
              ctx.beginPath();
              ctx.arc(item.x + 10, item.y + 10, 10, 0, Math.PI * 2);
              ctx.fill();
              ctx.strokeStyle = '#ffff00';
              ctx.lineWidth = 2;
              ctx.stroke();
              break;
          }
        }
      });

      // æ•µæç”»
      ctx.fillStyle = '#ff4444';
      enemies.forEach(enemy => {
        ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
        
        // æ•µã®ç›®
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(enemy.x + 5, enemy.y + 8, 5, 5);
        ctx.fillRect(enemy.x + 20, enemy.y + 8, 5, 5);
      });

      // ã‚´ãƒ¼ãƒ«æç”»
      ctx.fillStyle = '#ffff00';
      ctx.fillRect(goal.x, goal.y, goal.width, goal.height);
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 3;
      ctx.strokeRect(goal.x, goal.y, goal.width, goal.height);

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æç”»
      if (!player.invulnerable || Math.floor(player.invulnerableTime / 5) % 2 === 0) {
        ctx.fillStyle = player.color;
        ctx.fillRect(player.x, player.y, player.width, player.height);
        
        // ã‚·ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        if (powerUps.shield.active) {
          ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.arc(player.x + player.width/2, player.y + player.height/2, 25, 0, Math.PI * 2);
          ctx.stroke();
        }
      }

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æç”»
      particles.forEach(p => {
        ctx.globalAlpha = p.life / 30;
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
      });
      ctx.globalAlpha = 1;

      // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—çŠ¶æ…‹è¡¨ç¤º
      let hudY = 30;
      ctx.font = '12px Arial';
      if (powerUps.speedBoost.active) {
        ctx.fillStyle = '#00ffff';
        ctx.fillText(`SPEED: ${Math.ceil(powerUps.speedBoost.timer / 60)}s`, 10, hudY);
        hudY += 20;
      }
      if (powerUps.highJump.active) {
        ctx.fillStyle = '#ff00ff';
        ctx.fillText(`JUMP: ${Math.ceil(powerUps.highJump.timer / 60)}s`, 10, hudY);
        hudY += 20;
      }
      if (powerUps.shield.active) {
        ctx.fillStyle = '#ffff00';
        ctx.fillText(`SHIELD: ${Math.ceil(powerUps.shield.timer / 60)}s`, 10, hudY);
      }
    }

    // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
    function gameLoop() {
      if (gameState === 'playing') {
        updatePlayer();
        updateEnemies();
        updateItems();
        updateParticles();
        checkGoal();
        draw();
      }
      animationId = requestAnimationFrame(gameLoop);
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>
